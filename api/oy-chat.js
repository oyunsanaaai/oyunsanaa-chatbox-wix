export default async function handler(req, res) {
  try {
    const body = req.body || {};
    const msg = body.msg || '';

    if (!msg) {
      return res.status(400).json({
        error: 'Empty message',
        hint: 'Send {"msg":"..."}'
      });
    }

    // ===== Persona + system prompt =====
    const persona = String(body.persona || '').trim() || 'soft';

    const personaPrompts = {
      soft: `–ß–∏ "–û—é—É–Ω—Å–∞–Ω–∞–∞" ‚Äî –∑”©”©–ª”©–Ω, —Ö–∞–ª–∞–º–∂—Ç–∞–π, —Ö”©–≥–∂–∏–ª—Ç—ç–π. 
      2‚Äì6 ”©–≥“Ø“Ø–ª–±—ç—Ä—ç—ç—Ä –±–æ–≥–∏–Ω–æ —Ö–∞—Ä–∏—É–ª—Ç ”©–≥. 
      –•—ç—Ç —É—Ä—Ç –ª–µ–∫—Ü –±“Ø“Ø –±–∏—á. –ê–º—å–¥ —è—Ä–∏–∞–Ω—ã ”©–Ω–≥”©, —Å—ç—Ç–≥—ç–ª —Ç–∞–π–≤—à—Ä—É—É–ª—Å–∞–Ω –±–∞–π–≥.`,
      - –≠–º–ø–∞—Ç–∏ –∏–ª—ç—Ä—Ö–∏–π–ª: ‚Äú–æ–π–ª–≥–æ–∂ –±–∞–π–Ω–∞‚Äù, ‚Äú—Å–∞–Ω–∞–∞ –∑–æ–≤–æ–ª—Ç–≥“Ø–π —ç—ç‚Äù –≥—ç—Ö –º—ç—Ç.
      - –û–Ω–æ—à —Ç–∞–≤–∏—Ö, —ç–º—á–∏–ª–≥—ç—ç –±–∏—á–∏—Ö–≥“Ø–π; —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π –±–æ–ª –º—ç—Ä–≥—ç–∂–∏–ª—Ç—ç–Ω —Ä“Ø“Ø —Å–æ—ë–ª—Ç–æ–π —á–∏–≥–ª“Ø“Ø–ª.`,   
      tough: `–ß–∏ "–û—é—É–Ω—Å–∞–Ω–∞–∞" ‚Äî —Ö–∞—Ç—É—É —á–∞–Ω–≥–∞, –∑–æ—Ä–∏–ª–≥–æ —á–∏–≥–ª“Ø“Ø–ª—ç–≥—á. 
      2‚Äì4 ”©–≥“Ø“Ø–ª–±—ç—Ä. –®–∏–π–¥—ç–º–≥–∏–π, —É—Ä–∞–º –∑–æ—Ä–∏–≥ ”©–≥.`,
      wise: `–ß–∏ "–û—é—É–Ω—Å–∞–Ω–∞–∞" ‚Äî —É—Ö–∞–∞–ª–∞–≥, —Ç–∞–π–≤–∞–Ω, –≥“Ø–Ω–∑–≥–∏–π. 
      –ë–æ–≥–∏–Ω–æ –º”©—Ä”©–Ω–¥ 2‚Äì4 ”©–≥“Ø“Ø–ª–±—ç—Ä, –æ–π–ª–≥–æ–º–∂—Ç–æ–π —Ç–∞–π–ª–±–∞—Ä —Ö–∏–π.`,
      - –≠–Ω–≥–∏–π–Ω –∂–∏—à—ç—ç–≥—ç—ç—Ä —Ç–∞–π–ª–±–∞—Ä–ª–∞.`,
      parent: `–ß–∏ "–û—é—É–Ω—Å–∞–Ω–∞–∞" ‚Äî —ç—ç–∂/–∞–∞–≤ —à–∏–≥ –¥—É–ª–∞–∞–Ω, —Ö–∞–ª–∞–º–∂—Ç–∞–π. 
      2‚Äì4 ”©–≥“Ø“Ø–ª–±—ç—Ä—ç—ç—Ä —Ö–∞–π—Ä —Ö–∞–ª–∞–º–∂, —É—Ä–∞–º ”©–≥.
      - –≠—Ö—ç–Ω–¥ –Ω—å —Ç–∞–π–≤—à—Ä—É—É–ª, —Ö–∞–π—Ä –º—ç–¥—Ä“Ø“Ø–ª.
      - –•—ç—Ç —Ö–∞—Ç—É—É –±–∏—à; –∑”©”©–ª”©–Ω —Å–∞–Ω—É—É–ª–≥–∞ –±–∞ –∂–∏–∂–∏–≥ –¥–∞–∞—Ö—É–π—Ü –∞–ª—Ö–∞–º —Å–∞–Ω–∞–ª –±–æ–ª–≥–æ.`,  
      };

    const systemContent = personaPrompts[persona] || personaPrompts.soft;

    const messages = [
      { role: 'system', content: systemContent },
      { role: 'user', content: msg }
    ];

    // ===== OpenAI –¥—É—É–¥–ª–∞–≥–∞ =====
    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: body.model || 'gpt-4o-mini',
        messages,
        temperature: 0.6,
        top_p: 0.8,
        presence_penalty: 0.3,
        frequency_penalty: 1.0,
        max_tokens: Math.min(180, Number(body.max_tokens_hint || 160)),
        stop: ["\n\n", "###"]
      })
    });

    if (!r.ok) {
      const text = await r.text().catch(() => '');
      return res.status(r.status).json({ error: 'upstream', detail: text });
    }

    // ===== –•–∞—Ä–∏—É–ª—Ç –±–æ–ª–æ–≤—Å—Ä—É—É–ª–∞—Ö =====
    const data = await r.json();
    let reply = data.choices?.[0]?.message?.content || '';

    reply = reply
      .replace(/^\s*(#+|[-*]+)\s*/gm, '')  // heading / bullet –∞—Ä–∏–ª–≥–∞—Ö
      .replace(/\n{2,}/g, '\n')            // —Ö–æ–æ—Å–æ–Ω –º”©—Ä —Ü—ç–≥—Ü–ª—ç—Ö
      .trim();

    // –≠—Ö–Ω–∏–π –º–µ—Å—Å–µ–∂ –±–æ–ª —Ç–∞–Ω–∏–ª—Ü—É—É–ª–≥–∞ –Ω—ç–º
    const isFirstTurn = !Array.isArray(body.history) || body.history.length === 0;
    reply = addIntroOnce(reply, isFirstTurn);
    reply = addWarmClosing(reply, persona);

    return res.status(200).json({ reply, model: data.model });

  } catch (e) {
    console.error(e);
    return res.status(500).json({ error: 'server', detail: String(e.message || e) });
  }
}

// ===== Helper functions =====
function addIntroOnce(text, isFirst) {
  if (!text) return '';
  if (!isFirst) return String(text);
  const intro = '–°—ç—Ç–≥—ç–ª–∏–π–Ω —Ç—É—Å–ª–∞—Ö –û—é—É–Ω—Å–∞–Ω–∞–∞ –±–∞–π–Ω–∞. –¢–∞–Ω—å–¥ —é—É–≥–∞–∞—Ä —Ç—É—Å–ª–∞—Ö —É—É?';
  const t = String(text).trim();
  if (t.startsWith(intro)) return t;
  return `${intro} ${t}`;
}

function addWarmClosing(text, persona = 'soft') {
  const closings = {
  soft:
      '–•—ç—Ä–≤—ç—ç –æ–¥–æ–æ –∂–∞–∞—Ö–∞–Ω —Ö—ç—Ü“Ø“Ø –±–∞–π–≤–∞–ª –∞–º—Å—Ö–∞–∞–¥ –∞–≤–∞–∞—Ä–∞–π. ' +
      '–î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö–æ—ë—Ä –≥—É—Ä–≤–∞–Ω –∞–ª—Ö–º–∞–∞ —Ö–∞–º—Ç —Ç–æ–¥—Ä—É—É–ª—å—è —É—É?'
      '–ß–∏ –≥–∞–Ω—Ü–∞–∞—Ä–∞–∞ –±–∏—à —à“Ø“Ø. üòä',
      '–ë–∏ —á–∞–º—Ç–∞–π —Ö–∞–º—Ç –±–∞–π–Ω–∞.',
      '–ê–º–∞—Ä —Ç–∞–π–≤–∞–Ω –∞–º—å—Å–≥–∞–ª–∞–∞–¥, —Ü–∞–∞—à–∞–∞ —Ö–∞–º—Ç –∞–ª—Ö—ä—è.'
    tough:
      '–û–¥–æ–æ–≥–æ–æ—Ä –Ω—ç–≥ –∂–∏–∂–∏–≥ –∞–ª—Ö–∞–º —Å–æ–Ω–≥–æ–æ–¥ —à—É—É–¥ —Ö–∏–π–µ. ' +
      '–î—É—É—Å–º–∞–≥—Ü –Ω–∞–¥–∞–¥ —Ö—ç–ª—ç—ç—Ä—ç–π, –¥–∞—Ä–∞–∞–≥–∏–π–Ω—Ö—ã–≥ –Ω—å “Ø—Ä–≥—ç–ª–∂–ª“Ø“Ø–ª—å–µ.'
      '–û–¥–æ–æ –∂–∏–∂–∏–≥—Ö—ç–Ω 1 –∞–ª—Ö–∞–º —Ö–∏–π–µ.',
      '–•–æ–π—à–ª—É—É–ª–∞—Ö —Ç—É—Å–∞–º —Ö—ç—Ü“Ø“Ø –±–æ–ª–Ω–æ, –æ–¥–æ–æ —ç—Ö—ç–ª—å–µ.',
      '–ß–∏ —á–∞–¥–Ω–∞‚Äî–æ–¥–æ–æ—Ö–æ–Ω–¥–æ–æ –∂–∏–∂–∏–≥ –∞–ª—Ö–∞–º —Ö–∞–Ω–≥–∞–ª—Ç—Ç–∞–π.'
    wise:
      '”®–Ω”©”©–¥—Ä–∏–π–Ω –º—ç–¥—Ä—ç–º–∂ –Ω—å –º–∞—Ä–≥–∞–∞—à–∏–π–Ω —É—Ö–∞–∞—Ä–∞–ª –±–æ–ª–∂ —Ö—É–≤–∏—Ä–¥–∞–≥. ' +
      '–ß–∞–º–¥ —Ö–∞–º–≥–∏–π–Ω “Ø–Ω—ç —Ü—ç–Ω—Ç—ç–π —Å–∞–Ω–∞–≥–¥—Å–∞–Ω –Ω—ç–≥ —Å–∞–Ω–∞–∞–≥–∞–∞ —Ö—ç–ª—ç—Ö “Ø“Ø?'
      '–û–¥–æ–æ–≥–∏–π–Ω –º—ç–¥—Ä—ç–º–∂—ç—ç –∞–Ω–∑–∞–∞—Ä—á, –Ω—ç–≥ ”©–≥“Ø“Ø–ª–±—ç—Ä—ç—ç—Ä —Ö—ç–ª—ç—ç–¥ “Ø–∑—å–µ.',
      '–ë–∞–π–¥–∞–ª–¥ —Ç–∞–π–≤–∞–Ω —Ö–∞–Ω–¥–∞–∂, –¥–∞—Ä–∞–∞–≥–∏–π–Ω –∂–∏–∂–∏–≥ –∞–ª—Ö–º–∞–∞ —Å–æ–Ω–≥–æ—ë.',
      '–¢—ç–≤—á—ç—ç—Ä—Ç—ç–π –±–∞–π—Ö–∞–¥ –±“Ø—Ö –∑“Ø–π–ª —Ç–æ–¥–æ—Ä–Ω–æ.'
    parent:
      '–•–æ–æ–ª —É–Ω–¥, –Ω–æ–π—Ä–æ–æ –º–∞—Ä—Ç—É—É–∑–∞–π, –º–∏–Ω–∏–π —Ö–∞–º–≥–∏–π–Ω “Ø–Ω—ç —Ü—ç–Ω—ç—Ç—ç–π —ç—Ä–¥—ç–Ω—ç  –º–∏–Ω—å —ç—ç. ' +
      '–û–¥–æ–æ —Ö–∞–º–≥–∏–π–Ω –∏—Ö —Ç–∞–π—Ç–≥–∞—Ä—É—É–ª–∞—Ö –∑“Ø–π–ª —á–∞–º–¥ —é—É –≤—ç?' 
      '”®”©—Ä–∏–π–≥”©”© –±–∞–≥–∞ –∑—ç—Ä—ç–≥ —Ö–∞–π—Ä–ª–∞–∞—Ä–∞–π –∑–∞.–ß–∏ –±–æ–ª –æ–Ω—Ü–≥–æ–π –Ω—ç–≥—ç–Ω —à“Ø“Ø ü§ó',
      '”®–Ω”©”©–¥”©—Ä –∂–∞–∞—Ö–∞–Ω –∞–º–∞—Ä—á–ª–∞–∞–¥, –º–∞—Ä–≥–∞–∞—à –Ω—å –∂–∏–∂–∏–≥ –∞–ª—Ö–º–∞–∞ —Ö–∏–π–Ω—ç —ç—ç.',
      '”®”©—Ä–∏–π–≥”©”© –±–∏—Ç–≥–∏–π –∑—ç–º–ª—ç—ç—Ä—ç–π, —á–∏ —Ö–∞–Ω–≥–∞–ª—Ç—Ç–∞–π —Ö–∏—á—ç—ç–∂ –±–∞–π–Ω–∞.';
  const t = String(text || '').trim();
  const needPunct = !/[.!?‚Ä¶]$/.test(t);
  return `${t}${needPunct ? '.' : ''} ${closings[persona] || closings.soft}`;
}
