async function send(){
  const t = (el.input?.value || '').trim();
  if(!t){ meta('–ñ–∏—à—ç—ç: "–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É?"'); return; }
  if(!state.current){ bubble('–≠—Ö–ª—ç—ç–¥ –°—ç—Ç–≥—ç–ª–∏–π–Ω —Ö”©—Ç”©—á”©”©—Å —á–∞—Ç —Å–æ–Ω–≥–æ–æ—Ä–æ–π. üåø','bot'); el.input.value=''; return; }

  bubble(esc(t),'user'); pushMsg(state.current,'user',esc(t));
  el.input.value=''; el.send.disabled = true;

  let hist=[]; 
  try{ hist = JSON.parse(localStorage.getItem(msgKey(state.current))||'[]'); }catch(_){}
  if(hist.length > HISTORY_LIMIT) hist = hist.slice(-HISTORY_LIMIT);

  const typingEl = showTyping(); // –±–∏—á–∏–∂ –±–∞–π–Ω–∞ ‚Ä¶

  try{
    // –£—Ä—Ç –∞—Å—É—É–ª—Ç ‚Üí 4o, –±–æ–≥–∏–Ω–æ ‚Üí 4o-mini (UI-–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö–≥“Ø–π)
    const chosenModel = t.length > 220 ? 'gpt-4o' : 'gpt-4o-mini';

    const r = await fetch('/api/oy-chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model: chosenModel,
        persona: 'soft',
        msg: t,
        chatSlug: state.current || '',
        history: hist,
        max_tokens_hint: t.length < 45 ? 180 : 260
      })
    });

    const {reply,error} = await r.json().catch(()=>({error:'Invalid JSON'}));
    typingEl.remove();

    if(error) throw new Error(error);
    const safe = esc(reply || '–û–¥–æ–æ—Ö–æ–Ω–¥–æ–æ —Ö–∞—Ä–∏—É –æ–ª–¥—Å–æ–Ω–≥“Ø–π.');
    bubble(safe,'bot'); pushMsg(state.current,'bot',safe); save();
  }catch(e){
    typingEl.remove();
    console.error(e);
    bubble('‚ö†Ô∏è –•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞ —ç—Å–≤—ç–ª API —Ç–æ—Ö–∏—Ä–≥–æ–æ –¥—É—Ç—É—É –±–∞–π–Ω–∞.','bot');
  }finally{
    el.send.disabled=false; autoScroll();
  }
}
